Training Acceleration Curves

The goal is to generate smooth, predictable motion from 3 DC motors we know
very little about. We start with these assumptions:
- The angular velocity of each motor is roughly equal to the velocity of the
 thread going through the eyebolt, which is nearly the same as the motion of
 the ball in the direction of the eyebolt.
- The motor has 256 different power settings (actually a PWM 9V signal).
- The relationship between the power setting and the change in angular
 velocity can accurately be modeled by given the tension on the thread and
 the current velocity.
- Furthermore, a change in velocity can be modeled as a low order polynomal
 (quadratic) equation of the power setting, current velocity and expected
 tension.

We proceed in 3 steps: assess geometry, compute target acceleration, and train
model.


Assessing Geometry:

Let Ei be the location of the eyebolt i, and P be the location of the ball.
Let Ai = |Ei-P|, pointing from the ball to eyebolt i.
Let Bi = |A(i-1) x A(i+1)|, a normal perpendicular to the plane formed by the
 ball and the other two eyebolts.
Let ai be the acceleration of the thread passing through eyebolt i.
Let G be the force due to gravity in the -z direction.

The balls net accleration will be:

1) A = sum(ai Bi (Bi . Ai), i=1,3) + G

Which says the force applied to the ball from each thread will be applied
in the direction of the eyebolt, but will only act on the ball in the 
direction Bi (the rest of the force will cause tension on the other threads). 


Computing Target Acceleration:

We start by assuming we can model the acceleration due motor i as a quadratic
polynomial equation of 3 variables: current velocity, predicted
acceleration, and the power setting, qi,. Current velocity, vi, is a
scalar given by:

2) vi = (|Ei-P1|-|Ei-P0|)/t

Where P0 and P1 are successive measurements of the ball position and t is the
time between measurements. We need to be able to solve for the 3 power
settings, qi, that either give us a target average velocity, V1, or a target
destination, P. We will assume the time between successive measurements and
calculations is short enough that:

3) V ~= V0 + At/2

and

4) P1 ~= P0 + V0t + At^2/2

So, we have some idea of the expected position and velocity, so long as we
know A. All our knowledge of a motor's behavior will be summarized in a
quadratic equation of our three variables qi, vi, and ai.

5) C1i*Di + C2i*Ei + C3i*Fi + C0i = 0

Where Di is a vector of the squares of the parameters, [qi, vi, ai] (the power
setting, current velocity, and acceleration), Ei is [qi*vi, vi*ai, ai*qi] and 
Fi is [qi^2,vi^2,ai^]. C1i-C3i are 3x1 vectors of constants and C0i is a
scalar.

We do not expect to be able to find an equation of this form that is accurate
as we go from positive to negative power settings (and positive and negative)
acceleration. Observations show that there is a range on the power axis around
0 where the ball neither rises nor falls. The idea is to split the above
equation into positive and negative regions, so that, if we require positive
acceleration we use the positive version of it, seeking a positve power 
setting. If we need a negative acceleration, we negate the velocity input and
then negate the derived power setting. If our constants are accurate, then
we'll never be in one of these in-between regions. The positive and negative
equations are identical (aside from negating the velocity), and it would be
possible to use the same constants for each, but we will start with separate
sets of constants to determine whether there is any aysmetry in the motor
motions (this might also compenstate for error generated by our physics
assumptions). 

Derivation of our next power setting for motion along a curve f(t) should look
something like this:
* Measure the current position, P0, and calcuate V0 as (P0-Pprev)/t.
* Find the A such that P0 + V0 dt + .5 A dt^2 = f(t0+dt) where t0 is now and
 dt is the expected time between samples.
* Use equations 1 and 2, to derive ai and vi for each motor.
* For each motor, choose the right version of 5 depending on whether ai is 
 positive or negative. Compute qi using the quadratic equation. Choose the
 smallest, positive, real solution. A solution should always exist, but it
 might be greater than the availble power range. Perhaps choose the highest
 setting in this case and hope we recover at subsequent samples.
* Apply calculated power to motor.


Training the Model

We start by assuming C0i is zero, C2i and C3i contain all zeros, and C1i
is [-c,0,1]. This is the (bad) assumption that ai = c qi. These non-zero
values permit us to find a solution to qi at the begining of traing. The
initial value c, should be small so that we start off underestimating qi
(and prevent breaking things).

At each sample, we derive actual acceleration by solving the equation:

6) Pprev + Vprev dt + .5 A dt^2 = P0

Where Pprev and Vprev are the position and estimated velocity at the previous
sample, P0 is the current position measurement, and dt is now the actual time
between samples. We use equation 1 to split the acceleration, A, into the
components, ai, due to each motor. We now have a training example [qi, vi, ai]
for each motor, which we add to a set of previous training examples. We then
then use linear regresion against the training set on equation 5 to compute
new estimates for the constants C0i-C3i. We might want itererpolate the change
in constants using some learning factor. This will be especially important
early on when our position data consists mostly of noise and extreme changes
in the constants might result in a violent response from the motors.

The trianing program should start with the ball in the center of the eyebolts
and the kinects viewing angle. It should then pick random points in a small
sphere around that point and try to move the ball in a straight line to those
points using an easing curve that accelerates up to a fixed velocity and then
decellerates down in time to stop at the point. The velocity should start low
and the acceleration should be modest and constant. As the training progresses
(hopefully based on some accuracy score), the sphere from which points can be
chosen should be expanded, the maximum velocity should be increased, and the 
acceleration should be varied. We can also start looking at continuous easing
curves that might provide more coverage of the parameter space. When the sphere
cannot be increased any larger, we should start looking at moving the ball
along more complicated spacial curves with constant velocity. If this can be
acheived with high accuracy, training is done.